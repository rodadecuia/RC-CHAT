(()=>{"use strict";var e={268:e=>{e.exports=require("./models/Chat")},449:e=>{e.exports=require("./models/Help")},713:e=>{e.exports=require("./models/Baileys")},818:e=>{e.exports=require("dotenv")},829:e=>{e.exports=require("jsonwebtoken")},857:e=>{e.exports=require("os")},904:e=>{e.exports=require("mime-types")},1043:e=>{e.exports=require("@aws-sdk/client-s3")},1702:function(e,t,r){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.loggerBaileys=t.logger=void 0,t.setSocketIo=async function(e){n.io=e},t.socketSendBuffer=async function(){n.io&&(a(),i.forEach(e=>{n.io.to("backendlog").emit("backendlog",e)}))},t.initLogger=function(e,t){return(0,s.default)({level:t,transport:{target:"pino-pretty",options:{levelFirst:!0,translateTime:!0,colorize:!0}},hooks:{logMethod(t,r){l(t,e),r.apply(this,t)}}})};const s=o(r(4552)),n={io:null},i=[];function a(){const e=Date.now();for(;i.length>0&&e-i[0].timestamp>3e5;)i.shift()}async function d(e,t){if(!n.io)return;const r={timestamp:Date.now(),level:e,logs:t};i.push(r),a(),n.io.to("backendlog").emit("backendlog",r)}function l(e,t){const r=e.length>=2&&"string"!=typeof e[0]?1:0;"string"==typeof e[r]?e[r]=`[${t}]: ${e[r]}`:"object"==typeof e[r]&&(e[r].subsystem=t)}t.logger=(0,s.default)({level:process.env.LOG_LEVEL??"info",transport:{target:"pino-pretty",options:{levelFirst:!0,translateTime:!0,colorize:!0}},hooks:{logMethod(e,t,r){d(r,e).catch(()=>{}),l(e,"ticketz"),t.apply(this,e)}}}),t.loggerBaileys=(0,s.default)({timestamp:()=>`,"time":"${(new Date).toJSON()}"`,level:process.env.BAILEYS_LOG_LEVEL??"error",transport:{target:"pino-pretty",options:{levelFirst:!0,translateTime:!0,colorize:!0}},hooks:{logMethod(e,t,r){d(r,e).catch(()=>{}),l(e,"baileys"),t.apply(this,e)}}})},1836:e=>{e.exports=require("./models/UserSocketSession")},1848:function(e,t,r){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),o(r(818)).default.config({path:".env"})},1985:e=>{e.exports=require("./models/Plan")},2342:e=>{e.exports=require("./models/Contact")},2429:function(e,t,r){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.default=async function(e,t,r,o){if(!(e&&e.data&&e.mimetype&&t))throw d.logger.error("saveMediaToFile: Invalid media or destination provided"),new Error("Invalid media or destination provided");if(!e.filename){const t=e.mimetype.split(";")[0],r=i.default.extension(t)||"bin";e.filename=`${(new Date).getTime()}.${r}`}const c=(0,u.makeRandomId)(10),p="number"==typeof t?t:t.companyId;o||(o="number"==typeof t?void 0:t.contactId),r||(r="number"==typeof t?void 0:t.id);let g=`media/${p}/`;o&&r&&(g+=`${o}/${r}/`),g+=`${c}`;const h=l.S3Storage.getInstance();await h.prepare();const f=h.storage||new s.FileStorage(new n.LocalStorageAdapter((0,a.getPublicPath)())),m=`${g}/${e.filename}`;try{await f.write(m,e.data)}catch(e){throw d.logger.error({message:e.message},"Error saving media file"),new Error("Failed to save media file")}return h.storage?.publicUrl(m)||m};const s=r(5473),n=r(5870),i=o(r(904)),a=r(7434),d=r(1702),l=r(7503),u=r(6302)},2609:e=>{e.exports=require("./models/BaileysKeys")},2734:function(e,t,r){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.WorkerManager=void 0;const s=r(8167),n=r(6261),i=o(r(857)),a=r(4354),d=r(1702),l=r(6302),u=r(7470);r(6966);const c=r(7162);let p="main";class g extends n.EventEmitter{constructor(e){super();const t=i.default.cpus().length;this.minThreads=e?.minThreads??(t>4?4:t),this.maxThreads=e?.maxThreads??(t>4?t-1:t),this.timeout=e?.timeout??3e4,this.workers=[],this.taskQueue=[],this.activeTasks=new Map,this.mutex=new a.Mutex,this.initWorkers()}initWorkers(){for(let e=0;e<this.minThreads;e+=1)this.addWorker()}createWorker(){const e=new s.Worker(__filename.endsWith("bundle.o.js")?"./dist/bundle.worker.js":__filename),t={worker:e,busy:!1};return e.on("message",e=>this.handleWorkerMessage(t,e)),e.on("error",e=>this.handleWorkerError(t,e)),e.on("exit",e=>this.handleWorkerExit(t,e)),t}async sendStats(){const e=(0,c.getIO)();if(!e)return;const t={min:this.minThreads,max:this.maxThreads,workers:this.workers.length,queue:this.taskQueue.length,active:this.activeTasks.size};e.to("super").emit("workerStats",t)}addWorker(){if(this.workers.length>=this.maxThreads)return null;const e=this.createWorker();return this.workers.push(e),this.sendStats(),e}handleWorkerMessage(e,t){d.logger.debug({message:t,threadId:e.worker.threadId},"Received message from worker");const{taskId:r,result:o,error:s}=t,n=this.activeTasks.get(r);n&&(clearTimeout(n.timeout),s?n.reject(s):n.resolve(o),this.activeTasks.delete(r)),this.sendStats(),this.processNextTask(e)}handleWorkerError(e,t){d.logger.error({err:t},"Worker error"),this.removeWorker(e)}handleWorkerExit(e,t){d.logger.debug(`Worker exited with code ${t}`),this.removeWorker(e)}removeWorker(e,t=!1){!t&&this.workers.length<=this.minThreads||(d.logger.debug(`Removing worker ${e.worker.threadId}`),this.workers=this.workers.filter(t=>t!==e),e.worker.terminate(),this.sendStats(),this.workers.length<this.minThreads&&this.addWorker())}findAvailableWorker(){return this.workers.find(e=>!e.busy)||this.addWorker()}async processNextTask(e=null){const t=(0,l.makeRandomId)(10);d.logger.debug(`Waiting for lock for task ${t}`);const r=(e,r)=>{d.logger.debug(`Task ${e.taskId} timed out / lockId ${t}`),this.activeTasks.delete(e.taskId),e.reject(new Error("Task timed out")),this.removeWorker(r,!0)};this.mutex.runExclusive(async()=>{if(d.logger.debug(`Obtained lock ${t}`),0===this.taskQueue.length)return void(e&&(e.busy=!1,this.removeWorker(e)));const o=e||this.findAvailableWorker();if(!o)return;const s=this.taskQueue.shift();if(s){o.busy=!0,s.timeout=setTimeout(()=>r(s,o),this.timeout);try{o.worker.postMessage({taskId:s.taskId,taskHandler:s.taskHandler,taskData:s.taskData})}catch(e){s.reject(e),this.removeWorker(o,!0)}this.sendStats()}else o.busy=!1,this.removeWorker(o)}).then(()=>{d.logger.debug(`Released lock ${t}`)}).catch(e=>{d.logger.error({error:e},`Error processing next task - lockId ${t}`)})}static getInstance(e){return g.instance||(g.instance=new g(e)),g.instance}runTask(e,t){return new Promise((r,o)=>{const s=Date.now()+Math.random().toString(),n={taskId:s,taskHandler:e,taskData:t,resolve:r,reject:o,timeout:null};this.activeTasks.set(s,n),this.taskQueue.push(n),this.processNextTask()})}}if(t.WorkerManager=g,!s.isMainThread){p=`worker-${(0,l.makeRandomId)(10)}`;const e=(0,d.initLogger)(`ticketz-${p}`,process.env.LOG_LEVEL??"info");process.on("uncaughtException",t=>{e.error({err:t},`Uncaught Exception: ${t.message}`),"ERR_OSSL_BAD_DECRYPT"!==t.code&&process.exit(1)}),process.on("unhandledRejection",(t,r)=>{t instanceof TypeError?e.error({message:t.message,stack:t.stack.split("\n")},"Unhandled Rejection"):e.debug({promise:r,reason:t},"Unhandled Rejection")});const t={};h=new u.BaileysDownloader(s.parentPort),t[h.getName()]=h,s.parentPort.on("message",r=>{e.debug({message:r},`Worker ${p} received message`);const{taskId:o,taskHandler:s,taskData:n}=r,i=t[s];i?i.handleTask(o,n,{logger:e}):e.error(`Handler ${n.taskHandler} not found`)}),e.debug(`DownloadManager initialized in thread ${p}`)}var h},2888:e=>{e.exports=require("./models/UserQueue")},3e3:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.WorkerHandler=void 0,t.WorkerHandler=class{constructor(e){this.port=e,this.name=null,this.description=null,this.messagePort=e}getName(){return this.name}setName(e){this.name=e}getDescription(){return this.description}setDescription(e){this.description=e}}},3116:e=>{e.exports=require("./models/QuickMessage")},3237:e=>{e.exports=require("./models/Company")},3286:e=>{e.exports=require("@socket.io/admin-ui")},3329:e=>{e.exports=require("libzapitu-rf")},3357:function(e,t,r){var o,s=this&&this.__createBinding||(Object.create?function(e,t,r,o){void 0===o&&(o=r);var s=Object.getOwnPropertyDescriptor(t,r);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,o,s)}:function(e,t,r,o){void 0===o&&(o=r),e[o]=t[r]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||(o=function(e){return o=Object.getOwnPropertyNames||function(e){var t=[];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[t.length]=r);return t},o(e)},function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r=o(e),i=0;i<r.length;i++)"default"!==r[i]&&s(t,e,r[i]);return n(t,e),t}),a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.cacheLayer=void 0,t.setFromParams=h,t.getFromParams=f,t.delFromParams=m,t.set=v,t.get=k,t.getKeys=y,t.del=_,t.delFromPattern=b;const d=a(r(7659)),l=r(7070),u=a(r(9023)),c=i(r(6982)),p=new d.default(l.REDIS_URI_CONNECTION);function g(e){const t=JSON.stringify(e);return c.createHash("sha256").update(t).digest("base64")}function h(e,t,r,o,s){const n=`${e}:${g(t)}`;return void 0!==o&&void 0!==s?v(n,r,o,s):v(n,r)}function f(e,t){return k(`${e}:${g(t)}`)}function m(e,t){return _(`${e}:${g(t)}`)}function v(e,t,r,o){const s=u.default.promisify(p.set).bind(p);return void 0!==r&&void 0!==o?s(e,t,r,o):s(e,t)}function k(e){return u.default.promisify(p.get).bind(p)(e)}function y(e){return u.default.promisify(p.keys).bind(p)(e)}function _(e){return u.default.promisify(p.del).bind(p)(e)}async function b(e){const t=await y(e);for(let e of t)_(e)}t.cacheLayer={set:v,setFromParams:h,get:k,getFromParams:f,getKeys:y,del:_,delFromParams:m,delFromPattern:b}},3404:e=>{e.exports=require("./models/TicketTraking")},3509:e=>{e.exports=require("./models/Announcement")},3585:e=>{e.exports=require("./models/WebpushSubscription")},3853:e=>{e.exports=require("./models/NotificamehubIdMapping")},3898:e=>{e.exports=require("./models/Invoices")},4256:e=>{e.exports=require("./models/UserRating")},4286:e=>{e.exports=require("./models/Counter")},4354:e=>{e.exports=require("async-mutex")},4437:e=>{e.exports=require("socket.io")},4528:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.DecoupledDriverServices=void 0;const o=r(1702);class s{constructor(){this.functions={},o.logger.debug("DecoupledDriverServices initialized")}static getInstance(){return s.instance||(s.instance=new s),s.instance}registerFunction(e,t){o.logger.debug(`Registering function: ${e}`),this.functions[e]=t}getFunction(e){return this.functions[e]}}t.DecoupledDriverServices=s},4552:e=>{e.exports=require("pino")},4599:e=>{e.exports=require("./models/OutOfTicketMessages")},4620:e=>{e.exports=require("./models/CampaignSetting")},5005:function(e,t,r){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.GetCompanySetting=void 0;const s=o(r(7462)),n=o(r(7209)),i=r(5017),a=r(1702),d=new i.SimpleObjectCache(1e4,a.logger);t.GetCompanySetting=async(e,t,r=void 0,o=!1)=>{if(o){const r=d.get(`${e}-${t}`);if(r)return r}const i=await s.default.findOne({where:{companyId:e,key:t}});if(!i&&void 0===r)throw new n.default("ERR_NO_SETTING_FOUND",404);return o&&d.set(`${e}-${t}`,i?.value||r),i?i.value:r},t.default=async(e,t=null)=>{const r=await s.default.findOne({where:{companyId:1,key:e}});if(!r&&null===t)throw new n.default("ERR_NO_SETTING_FOUND",404);return r?.value||t}},5017:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.SimpleObjectCache=void 0,t.SimpleObjectCache=class{constructor(e,t=null){this.ttl=e,this.logger=t,this.cache=new Map}set(e,t){this.cache.has(e)&&(clearTimeout(this.cache.get(e).timer),this.logger?.trace(`Cache key ${e} was cleared`));const r=setTimeout(()=>{this.cache.delete(e),this.logger?.trace(`Cache key ${e} was expired`)},this.ttl);this.cache.set(e,{value:t,timer:r}),this.logger?.trace(`Cache key ${e} was saved`)}get(e){const t=this.cache.get(e);return t?(t.timer.refresh(),this.logger?.trace(`Cache key ${e} was accessed`),t.value):null}delete(e){const t=this.cache.get(e);t&&(clearTimeout(t.timer),this.cache.delete(e),this.logger?.trace(`Cache key ${e} was deleted`))}}},5060:e=>{e.exports=require("./models/Subscriptions")},5473:e=>{e.exports=require("@flystorage/file-storage")},5667:e=>{e.exports=require("./models/WhatsappQueue")},5694:e=>{e.exports=require("./models/ContactTag")},5720:e=>{e.exports=require("./models/Integration")},5840:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),r(1848),e.exports={define:{charset:"utf8mb4",collate:"utf8mb4_bin"},pool:{max:process.env.DB_MAX_CONNECTIONS||60,min:process.env.DB_MIN_CONNECTIONS||5,acquire:process.env.DB_ACQUIRE||3e4,idle:process.env.DB_IDLE||1e4},dialect:process.env.DB_DIALECT||"postgres",timezone:process.env.DB_TIMEZONE||"-03:00",host:process.env.DB_HOST,port:process.env.DB_PORT||5432,database:process.env.DB_NAME,username:process.env.DB_USER,password:process.env.DB_PASS,logging:process.env.DB_DEBUG&&console.log,seederStorage:"sequelize"}},5870:e=>{e.exports=require("@flystorage/local-fs")},5878:e=>{e.exports=require("./models/TicketTag")},6261:e=>{e.exports=require("events")},6302:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.makeRandomId=function(e){let t="";let r=0;for(;r<e;)t+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(Math.floor(62*Math.random())),r+=1;return t}},6906:e=>{e.exports=require("./models/TicketNote")},6928:e=>{e.exports=require("path")},6966:function(e,t,r){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=r(9521),n=o(r(7393)),i=o(r(7462)),a=o(r(2342)),d=o(r(5694)),l=o(r(8878)),u=o(r(8492)),c=o(r(8033)),p=o(r(8667)),g=o(r(7029)),h=o(r(8654)),f=o(r(9373)),m=o(r(5667)),v=o(r(2888)),k=o(r(3237)),y=o(r(1985)),_=o(r(6906)),b=o(r(3116)),I=o(r(449)),w=o(r(3404)),x=o(r(4286)),$=o(r(4256)),q=o(r(9600)),D=o(r(9807)),T=o(r(8746)),M=o(r(5878)),S=o(r(9198)),O=o(r(9897)),E=o(r(8112)),C=o(r(4620)),P=o(r(713)),j=o(r(7010)),R=o(r(3509)),N=o(r(268)),W=o(r(9947)),U=o(r(8567)),B=o(r(3898)),L=o(r(5060)),A=o(r(2609)),z=o(r(1836)),F=o(r(4599)),H=o(r(8817)),G=o(r(7312)),K=o(r(5720)),Q=o(r(8972)),J=o(r(3853)),X=o(r(9182)),V=o(r(3585)),Z=r(5840),Y=new s.Sequelize(Z),ee=[k.default,n.default,z.default,a.default,d.default,l.default,g.default,h.default,u.default,c.default,p.default,i.default,f.default,m.default,v.default,y.default,_.default,b.default,I.default,w.default,x.default,$.default,q.default,D.default,T.default,M.default,S.default,O.default,E.default,C.default,P.default,A.default,j.default,R.default,N.default,W.default,U.default,B.default,F.default,X.default,L.default,H.default,G.default,K.default,Q.default,J.default,V.default];Y.addModels(ee),t.default=Y},6982:e=>{e.exports=require("crypto")},7009:e=>{e.exports=require("@flystorage/aws-s3")},7010:e=>{e.exports=require("./models/CampaignShipping")},7029:e=>{e.exports=require("./models/Message")},7070:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.REDIS_OPT_LIMITER_DURATION=t.REDIS_OPT_LIMITER_MAX=t.REDIS_URI_CONNECTION=void 0,t.REDIS_URI_CONNECTION=process.env.REDIS_URI||"",t.REDIS_OPT_LIMITER_MAX=process.env.REDIS_OPT_LIMITER_MAX||1,t.REDIS_OPT_LIMITER_DURATION=process.env.REDIS_OPT_LIMITER_DURATION||3e3},7162:function(e,t,r){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.getIO=t.initIO=void 0;const s=r(4437),n=r(3286),i=r(829),a=o(r(7209)),d=r(1702),l=o(r(7393)),u=o(r(9373)),c=o(r(8878)),p=o(r(9467)),g=r(7979),h=o(r(1836)),f=r(5005),m=r(4528).DecoupledDriverServices.getInstance();let v;const k=async(e,t,r,o)=>{const s=o.incrementCounter(`ticket-${t}`);1===s&&e.join(t),d.logger.debug(`joinChatbox[${s}]: Channel: ${t} by user ${r.id}`)},y=(e,t,r)=>{v.to("super").to(`company-${e}-admin`).emit("userOnlineChange",{userId:t,online:r})};t.initIO=e=>(v=new s.Server(e,{cors:{origin:process.env.FRONTEND_URL}}),(0,d.setSocketIo)(v),process.env.SOCKET_ADMIN&&JSON.parse(process.env.SOCKET_ADMIN)&&l.default.findByPk(1).then(e=>{(0,n.instrument)(v,{auth:{type:"basic",username:e.email,password:e.passwordHash},mode:"development"})}),h.default.update({active:!1},{where:{active:!0}}).then(e=>{d.logger.debug("Clossing all socket sessions")}),v.on("connection",async e=>{d.logger.info("Client Connected");const{token:t}=e.handshake.query;let r=null;try{r=(0,i.verify)(t,p.default.secret),d.logger.debug(r,"io-onConnection: tokenData")}catch(t){return d.logger.debug(`Error decoding token: ${t?.message}`),e.disconnect(),v}const o=new g.CounterManager;let s=null;const n=r.id;return n&&"undefined"!==n&&"null"!==n?(s=await l.default.findByPk(n,{include:[u.default]}),s?(await s.save(),h.default.create({id:e.id,userId:n,active:!0}).then(t=>{d.logger.debug(`started session ${e.id} for user ${n}`),y(s.companyId,s.id,!0)}),e.on("disconnect",async()=>{h.default.update({active:!1},{where:{id:e.id}}).then(async()=>{d.logger.debug(`finished session ${e.id} for user ${n}`);const t=await h.default.count({where:{userId:n,active:!0}});y(s.companyId,s.id,t>0)})}),e.join(`company-${s.companyId}-mainchannel`),e.join(`user-${s.id}`),s.super&&e.join("super"),"admin"===s.profile&&e.join(`company-${s.companyId}-admin`),e.on("joinBackendlog",()=>{s.super?(e.join("backendlog"),v.to("backendlog").emit("backendlog",{timestamp:Date.now(),level:30,logs:[{currentLevel:d.logger.level},"started transmission of backend logs"]}),(0,d.socketSendBuffer)()):d.logger.info(`User ${s.id} tried to join superlog channel.`)}),e.on("leaveBackendlog",()=>{s.super?(v.to("backendlog").emit("backendlog",{timestamp:Date.now(),level:30,logs:["finished transmission of backend logs"]}),e.leave("backendlog")):d.logger.info(`User ${s.id} tried to leave superlog channel.`)}),e.on("setLoglevel",e=>{if(s.super){if(d.logger.level===e)return;d.logger.level=e,v.to("backendlog").emit("backendlog",{timestamp:Date.now(),level:30,logs:[`Log level changed to ${e}`]})}else d.logger.info(`User ${s.id} tried to set log level.`)}),e.on("joinChatBox",async t=>{t&&"undefined"!==t&&c.default.findByPk(t).then(async r=>{if(!r||r.companyId!==s.companyId||r.userId!==s.id&&"admin"!==s.profile)if(r.isGroup&&"enabled"===await(0,f.GetCompanySetting)(s.companyId,"groupsTab","disabled")){let n=!1;s.queues.forEach(e=>{e.id===r.queueId&&(n=!0)}),n?k(e,t,s,o):d.logger.info(`Invalid attempt to join channel of ticket ${t} by user ${s.id}`)}else d.logger.info(`Invalid attempt to join channel of ticket ${t} by user ${s.id}`);else k(e,t,s,o)},e=>{d.logger.error(e,`Error fetching ticket ${t}`)})}),e.on("leaveChatBox",async t=>{if(!t||"undefined"===t)return;const r=o.decrementCounter(`ticket-${t}`);0===r&&e.leave(t),d.logger.debug(`leaveChatbox[${r}]: Channel: ${t} by user ${s.id}`)}),e.on("joinNotification",async()=>{const t=o.incrementCounter("notification");1===t&&("admin"===s.profile?e.join(`company-${s.companyId}-notification`):s.queues.forEach(t=>{d.logger.debug(`User ${s.id} of company ${s.companyId} joined queue ${t.id} channel.`),e.join(`queue-${t.id}-notification`)})),d.logger.debug(`joinNotification[${t}]: User: ${s.id}`)}),e.on("leaveNotification",async()=>{const t=o.decrementCounter("notification");0===t&&("admin"===s.profile?e.leave(`company-${s.companyId}-notification`):s.queues.forEach(t=>{d.logger.debug(`User ${s.id} of company ${s.companyId} leaved queue ${t.id} channel.`),e.leave(`queue-${t.id}-notification`)})),d.logger.debug(`leaveNotification[${t}]: User: ${s.id}`)}),e.on("joinTickets",t=>{1===o.incrementCounter(`status-${t}`)&&("admin"===s.profile?(d.logger.debug(`Admin ${s.id} of company ${s.companyId} joined ${t} tickets channel.`),e.join(`company-${s.companyId}-${t}`)):"pending"===t?s.queues.forEach(t=>{d.logger.debug(`User ${s.id} of company ${s.companyId} joined queue ${t.id} pending tickets channel.`),e.join(`queue-${t.id}-pending`)}):d.logger.debug(`User ${s.id} cannot subscribe to ${t}`))}),e.on("leaveTickets",t=>{0===o.decrementCounter(`status-${t}`)&&("admin"===s.profile?(d.logger.debug(`Admin ${s.id} of company ${s.companyId} leaved ${t} tickets channel.`),e.leave(`company-${s.companyId}-${t}`)):"pending"===t&&s.queues.forEach(t=>{d.logger.debug(`User ${s.id} of company ${s.companyId} leaved queue ${t.id} pending tickets channel.`),e.leave(`queue-${t.id}-pending`)}))}),e.on("presenceUpdate",async e=>{const t=m.getFunction("presenceUpdate");t&&t(s,e)}),e.emit("ready"),v):(d.logger.info(`onConnect: User ${n} not found`),e.disconnect(),v)):(d.logger.info("onConnect: Missing userId"),e.disconnect(),v)}),v),t.getIO=()=>{if(!v)throw new a.default("Socket IO not initialized");return v}},7209:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=class{constructor(e,t=400,r="warn"){this.message=e,this.statusCode=t,this.level=r}}},7312:e=>{e.exports=require("./models/Wavoip")},7393:e=>{e.exports=require("./models/User")},7434:function(e,t,r){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.getPublicPath=void 0;const s=o(r(6928));t.getPublicPath=()=>__dirname.endsWith("/dist")?s.default.resolve(__dirname,"..","public"):s.default.resolve(__dirname,"..","..","public")},7462:e=>{e.exports=require("./models/Setting")},7470:function(e,t,r){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.BaileysDownloader=void 0;const s=r(3329),n=r(3e3),i=o(r(2429));class a extends n.WorkerHandler{constructor(e){super(e),this.setName("BaileysDownloader"),this.setDescription("Download media from WhatsApp using Baileys")}handleTask(e,t,{logger:r}){r.debug({taskData:t},"Downloading media"),t.directPath&&t.url&&(t.url=null),(0,s.downloadContentFromMessage)(t,t.mediaType).then(o=>{r.debug({taskData:t},"Media downloaded"),(0,i.default)({data:o,mimetype:t.mimetype||"application/octet-stream",filename:t.filename||`${(new Date).getTime()}.bin`},t.companyId,t.ticketId,t.contactId).then(t=>{r.debug({mediaUrl:t},"Media saved"),this.messagePort.postMessage({taskId:e,result:{mediaUrl:t}})}).catch(o=>{r.error({taskData:t},`Error saving media file: ${o.message}`),this.messagePort.postMessage({taskId:e,error:o})})}).catch(o=>{r.error({taskData:t},`Error downloading media file: ${o.message}`),this.messagePort.postMessage({taskId:e,error:o})})}}t.BaileysDownloader=a},7503:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.S3Storage=void 0;const o=r(1043),s=r(7009),n=r(5473),i=r(6982),a=r(1702),d=r(5005),l=r(7723),u={normalizePath(e){if(/\p{C}+/u.test(e))throw n.CorruptedPathDetected.unexpectedWhitespace(e);if(-1!==e.indexOf("../")||".."===e)throw n.PathTraversalDetected.forPath(e);return"."===e?"":e}};class c{async initialize(e){try{const t=JSON.parse(e);if(this.activeData=e,this.storage=null,this.failed=!1,!t.accessKeyId||!t.secretAccessKey)return void(this.failed=!0);const r={accessKeyId:t.accessKeyId,secretAccessKey:t.secretAccessKey};this.s3Config={region:t.region||void 0,endpoint:t.endpoint||void 0,forcePathStyle:!!t.endpoint,credentials:r},this.bucket=t.bucket;const d=new o.S3Client(this.s3Config);try{await d.send(new o.HeadBucketCommand({Bucket:this.bucket}))}catch(e){return"NotFound"!==e.name?(a.logger.error({error:e},"Error checking bucket"),void(this.failed=!0)):(a.logger.error({error:e},"Bucket not found"),this.failed=!0,void(this.activeData=null))}const c=new s.AwsS3StorageAdapter(d,{bucket:t.bucket,prefix:t.prefix||""},t.endpoint?new l.S3PublicUrlGenerator(t.endpoint):new s.DefaultAwsPublicUrlGenerator);d.middlewareStack.add((e,t)=>async t=>{if(t.input.Delete&&t.input.Delete.Objects){const e=(0,i.createHash)("md5").update(t.request.body).digest("base64");t.request.headers["Content-MD5"]=e}return e(t)},{step:"build"}),t.endpoint.endsWith("backblazeb2.com")&&d.middlewareStack.addRelativeTo((e,t)=>async t=>(t.request.headers&&(delete t.request.headers["x-amz-sdk-checksum-algorithm"],delete t.request.headers["x-amz-checksum-crc32"],delete t.request.headers["x-amz-checksum-crc32c"],delete t.request.headers["x-amz-checksum-sha1"],delete t.request.headers["x-amz-checksum-sha256"],delete t.request.headers["x-amz-checksum-algorithm"],delete t.request.headers["x-amz-checksum-mode"]),e(t)),{relation:"before",toMiddleware:"retryMiddleware",name:"removeChecksumHeadersMiddleware",override:!0}),this.storage=new n.FileStorage(c,u)}catch(e){this.failed=!0}}static getInstance(){try{return c.instance&&!c.instance.failed||(c.instance=new c),c.instance}catch(e){return a.logger.error(`Error initializing S3Storage: ${e}`),null}}async prepare(){const e=await(0,d.GetCompanySetting)(1,"s3ConfigData","{}");e!==this.activeData&&await this.initialize(e)}}t.S3Storage=c},7659:e=>{e.exports=require("ioredis")},7723:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.S3PublicUrlGenerator=void 0,t.S3PublicUrlGenerator=class{constructor(e){this.endpoint=e}async publicUrl(e,t){return`${this.endpoint}/${t.bucket}/${e}`}}},7979:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.CounterManager=void 0,t.CounterManager=class{constructor(){this.counters={}}incrementCounter(e,t=1){return this.counters[e]||(this.counters[e]={name:e,value:0}),this.counters[e].value+=t,this.counters[e].value}decrementCounter(e,t=1){return this.counters[e]?(this.counters[e].value-=t,this.counters[e].value<0&&(this.counters[e].value=0),this.counters[e].value):0}}},8033:e=>{e.exports=require("./models/WhatsappLidMap")},8112:e=>{e.exports=require("./models/Campaign")},8167:e=>{e.exports=require("worker_threads")},8492:e=>{e.exports=require("./models/Whatsapp")},8567:e=>{e.exports=require("./models/ChatMessage")},8654:e=>{e.exports=require("./models/OldMessage")},8667:e=>{e.exports=require("./models/ContactCustomField")},8746:e=>{e.exports=require("./models/Tag")},8817:e=>{e.exports=require("./models/Translation")},8878:e=>{e.exports=require("./models/Ticket")},8972:e=>{e.exports=require("./models/IntegrationSession")},9023:e=>{e.exports=require("util")},9182:e=>{e.exports=require("./models/QuickPix")},9198:e=>{e.exports=require("./models/ContactList")},9373:e=>{e.exports=require("./models/Queue")},9467:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0});const o=r(3357),s=r(1702);async function n(e){let t=await o.cacheLayer.get(e);return t?s.logger.debug(`[auth.ts] Loaded ${e}`):(t=function(){let e="";for(let t=0;t<32;t+=1)e+="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()-_=+"[Math.floor(76*Math.random())];return e}(),await o.cacheLayer.set(e,t),s.logger.debug(`[auth.ts] Generated ${e}`)),t}const i={secret:null,expiresIn:"15m",refreshSecret:null,refreshExpiresIn:"7d"},a=n("TICKETZ_JWT_SECRET"),d=n("TICKETZ_JWT_REFRESH_SECRET");Promise.all([a,d]).then(([e,t])=>{i.secret=e,i.refreshSecret=t}),t.default=i},9521:e=>{e.exports=require("sequelize-typescript")},9600:e=>{e.exports=require("./models/QueueOption")},9807:e=>{e.exports=require("./models/Schedule")},9897:e=>{e.exports=require("./models/ContactListItem")},9947:e=>{e.exports=require("./models/ChatUser")}},t={};!function r(o){var s=t[o];if(void 0!==s)return s.exports;var n=t[o]={exports:{}};return e[o].call(n.exports,n,n.exports,r),n.exports}(2734)})();